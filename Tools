#!/usr/bin/env bash

#
# å¤šåŠŸèƒ½è„šæœ¬å·¥å…·ç®±æ¡†æ¶ (çµæ„Ÿæ¥æº: kejilion.sh)
#

# é‡åˆ°ä»»ä½•é”™è¯¯åˆ™ç»ˆæ­¢è„šæœ¬ (åœ¨å‡½æ•°å†…éƒ¨æŒ‰éœ€ä½¿ç”¨)
# set -e

# --- é¢œè‰²å®šä¹‰ ---
# ä½¿ç”¨ tput åŠ¨æ€è·å–é¢œè‰²ä»£ç ï¼Œå…¼å®¹æ€§æ›´å¥½
if command -v tput >/dev/null 2>&1 && [[ $(tput colors) -ge 8 ]]; then
  C_RESET=$(tput sgr0)
  C_RED=$(tput setaf 1)
  C_GREEN=$(tput setaf 2)
  C_YELLOW=$(tput setaf 3)
  C_BLUE=$(tput setaf 4)
  C_CYAN=$(tput setaf 6)
else
  # å¦‚æœ tput ä¸å¯ç”¨ï¼Œåˆ™ä½¿ç”¨é™æ€ä»£ç 
  C_RESET='\033[0m'
  C_RED='\033[0;31m'
  C_GREEN='\033[0;32m'
  C_YELLOW='\033[0;33m'
  C_BLUE='\033[0;34m'
  C_CYAN='\033[0;36m'
fi

# --- è¾…åŠ©å‡½æ•° ---

# åŠŸèƒ½å®Œæˆåæš‚åœï¼Œç­‰å¾…ç”¨æˆ·æŒ‰ä»»æ„é”®ç»§ç»­
function press_any_key_to_continue() {
  echo -e "\n${C_YELLOW}æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•...${C_RESET}"
  # read a single character
  read -n 1 -s -r
}

# --- åŠŸèƒ½å‡½æ•°å®šä¹‰ ---
# è¿™é‡Œæ˜¯æ¯ä¸ªèœå•é€‰é¡¹å¯¹åº”çš„å…·ä½“åŠŸèƒ½å®ç°

# 1. ç³»ç»Ÿä¿¡æ¯æŸ¥è¯¢
function show_system_info() {
  clear
  echo -e "${C_CYAN}======== ç³»ç»Ÿä¿¡æ¯æŸ¥è¯¢ ========${C_RESET}"
  echo -e "ä¸»æœºå: ${C_GREEN}$(hostname)${C_RESET}"
  echo -e "æ“ä½œç³»ç»Ÿ: ${C_GREEN}$(source /etc/os-release && echo $PRETTY_NAME)${C_RESET}"
  echo -e "å†…æ ¸ç‰ˆæœ¬: ${C_GREEN}$(uname -r)${C_RESET}"
  echo -e "CPUå‹å·: ${C_GREEN}$(grep "model name" /proc/cpuinfo | head -n1 | cut -d: -f2)${C_RESET}"
  echo -e "å†…å­˜ä½¿ç”¨: ${C_GREEN}$(free -h | awk '/^Mem/ {print $3 "/" $2}')${C_RESET}"
  echo -e "ç¡¬ç›˜ä½¿ç”¨: ${C_GREEN}$(df -h / | awk 'NR==2 {print $3 "/" $2 " (" $5 ")"}') ${C_RESET}"
  echo -e "å…¬ç½‘IP: ${C_GREEN}$(curl -s ip.sb)${C_RESET}"
  echo -e "${C_CYAN}===============================${C_RESET}"
  press_any_key_to_continue
}

# 2. ç³»ç»Ÿæ›´æ–°
function update_system() {
  clear
  echo -e "${C_CYAN}======== å¼€å§‹æ›´æ–°ç³»ç»Ÿ ========${C_RESET}"
  if command -v apt-get &>/dev/null; then
    sudo apt-get update && sudo apt-get upgrade -y
  elif command -v yum &>/dev/null; then
    sudo yum update -y
  else
    echo -e "${C_RED}æœªçŸ¥çš„åŒ…ç®¡ç†å™¨ï¼Œæ— æ³•è‡ªåŠ¨æ›´æ–°ã€‚${C_RESET}"
  fi
  echo -e "${C_GREEN}ç³»ç»Ÿæ›´æ–°å®Œæˆï¼${C_RESET}"
  press_any_key_to_continue
}

# ... å…¶ä»–å ä½ç¬¦åŠŸèƒ½ ...
function ldnmp_setup() {
    echo -e "${C_YELLOW}åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...${C_RESET}"
    sleep 1
}

# 99. å®‰è£…å¿«æ·æŒ‡ä»¤
function install_shortcut() {
  # --- é…ç½® ---
  local script_url="https://raw.githubusercontent.com/wliuy/mypublic/refs/heads/main/Tools" # <-- ä¿®æ­£ä¸ºä½ æœ€ç»ˆç¡®è®¤çš„æœ‰æ•ˆURL
  local install_name="tools"
  local shortcut_name="y"
  local install_path="/usr/local/bin/${install_name}"
  local shortcut_path="/usr/local/bin/${shortcut_name}"

  # åœ¨éè‡ªåŠ¨å®‰è£…æ—¶ï¼ˆä»èœå•é€‰æ‹©ï¼‰å…ˆæ¸…å±
  if [[ "${auto_install}" != "true" ]]; then
    clear
  fi
  
  echo -e "${C_CYAN}å¼€å§‹å®‰è£…å¿«æ·æ–¹å¼ '${shortcut_name}'...${C_RESET}"

  # 1. æ£€æŸ¥ root æƒé™
  if [[ "$(id -u)" -ne 0 ]]; then
    echo -e "${C_RED}é”™è¯¯ï¼šå®‰è£…è¿‡ç¨‹éœ€è¦ root æƒé™æ‰èƒ½å†™å…¥ /usr/local/bin/${C_RESET}"
    echo -e "${C_YELLOW}è¯·å°è¯•ä½¿ç”¨ 'sudo bash <(curl...)' æ¥è¿è¡Œæ­¤è„šæœ¬ã€‚${C_RESET}"
    press_any_key_to_continue
    return 1 # è¿”å›å¤±è´¥çŠ¶æ€ç 
  fi

  # 2. ä¸‹è½½è„šæœ¬åˆ° /usr/local/bin
  echo -e "${C_BLUE}æ­£åœ¨ä» GitHub ä¸‹è½½æœ€æ–°ç‰ˆè„šæœ¬åˆ° ${install_path}...${C_RESET}"
  if curl -L "${script_url}" -o "${install_path}"; then
    echo -e "${C_GREEN}ä¸‹è½½æˆåŠŸï¼${C_RESET}"
  else
    echo -e "${C_RED}é”™è¯¯ï¼šä¸‹è½½è„šæœ¬å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–URLã€‚${C_RESET}"
    press_any_key_to_continue
    return 1 # è¿”å›å¤±è´¥çŠ¶æ€ç 
  fi

  # 3. æ·»åŠ æ‰§è¡Œæƒé™
  echo -e "${C_BLUE}æ­£åœ¨è®¾ç½®æ‰§è¡Œæƒé™...${C_RESET}"
  chmod +x "${install_path}"

  # 4. åˆ›å»ºå¿«æ·æ–¹å¼çš„ç¬¦å·é“¾æ¥
  echo -e "${C_BLUE}æ­£åœ¨åˆ›å»ºå¿«æ·å‘½ä»¤ '${shortcut_name}' -> '${install_path}'...${C_RESET}"
  ln -sf "${install_path}" "${shortcut_path}"

  # 5. æç¤ºæˆåŠŸä¿¡æ¯
  echo -e "\n${C_GREEN}ğŸ‰ æ­å–œï¼å¿«æ·æ–¹å¼å®‰è£…æˆåŠŸï¼${C_RESET}"
  echo -e "è¯·é‡æ–°æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯çª—å£, æˆ–æ‰§è¡Œ ${C_YELLOW}exec $SHELL${C_RESET} æ¥åˆ·æ–°ç¯å¢ƒã€‚"
  echo -e "ä¹‹å, ä½ å°±å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ç›´æ¥è¾“å…¥ '${C_YELLOW}${shortcut_name}${C_RESET}' æ¥è¿è¡Œæ­¤å·¥å…·ç®±äº†ã€‚"
  
  if [[ "${auto_install}" != "true" ]]; then
    press_any_key_to_continue
  fi
  return 0
}

# 00. è„šæœ¬æ›´æ–°
function update_script() {
  clear
  echo -e "${C_CYAN}æ­£åœ¨æ£€æŸ¥å¹¶æ›´æ–°è„šæœ¬...${C_RESET}"
  # è„šæœ¬æ›´æ–°é€»è¾‘å°±æ˜¯é‡æ–°æ‰§è¡Œä¸€æ¬¡å®‰è£…ï¼Œç”¨æ–°è„šæœ¬è¦†ç›–æ—§è„šæœ¬
  local auto_install="true" # æ ‡è®°ä¸ºé™é»˜å®‰è£…æ¨¡å¼ï¼Œé¿å…é‡å¤æ¸…å±
  install_shortcut
}


# --- ä¸»èœå•æ˜¾ç¤º ---
function main_menu() {
  clear
  echo -e "${C_CYAN}â–ˆâ–€â–€â€ƒâ–ˆâ–‘â–ˆâ€ƒâ–ˆâ–€â–€â€ƒâ–ˆâ€ƒâ–ˆâ–‘â–ˆâ€ƒâ–ˆâ–„â–„â€ƒâ–ˆâ–€â–€â€ƒâ–‘â–‘â€ƒâ–ˆâ–€â€ƒâ–ˆâ–‘â–ˆ${C_RESET}"
  echo -e "${C_CYAN}â–ˆâ–„â–„â€ƒâ–ˆâ–„â–ˆâ€ƒâ–ˆâ–ˆâ–„â€ƒâ–ˆâ€ƒâ–ˆâ–„â–ˆâ€ƒâ–ˆâ–„â–ˆâ€ƒâ–ˆâ–ˆâ–„â€ƒâ–„â–„â€ƒâ–„â–ˆâ€ƒâ–ˆâ–€â–ˆ${C_RESET}"
  echo -e "${C_BLUE}      ç§‘æŠ€lionè„šæœ¬å·¥å…·ç®± v1.0.0      ${C_RESET}"
  echo -e "${C_YELLOW}----------------------------------------${C_RESET}"
  echo -e " ${C_GREEN}1.${C_RESET} ç³»ç»Ÿä¿¡æ¯æŸ¥è¯¢      ${C_GREEN}2.${C_RESET} ç³»ç»Ÿæ›´æ–°"
  # ... çœç•¥éƒ¨åˆ†èœå•é¡¹ ...
  echo -e " ${C_GREEN}15.${C_RESET} å¹¿å‘Šä¸“æ "
  echo -e "${C_YELLOW}----------------------------------------${C_RESET}"
  echo -e " ${C_GREEN}99.${C_RESET} (é‡æ–°)å®‰è£…å¿«æ·æŒ‡ä»¤"
  echo -e " ${C_GREEN}00.${C_RESET} æ›´æ–°è„šæœ¬"
  echo -e " ${C_GREEN}0.${C_RESET}  é€€å‡ºè„šæœ¬"
  echo -e "${C_YELLOW}----------------------------------------${C_RESET}"
  read -p "è¯·è¾“å…¥ä½ çš„é€‰æ‹©: " choice
}

# --- ä¸»å¾ªç¯ ---
function main_loop() {
    while true; do
      main_menu
      case $choice in
      1)
        show_system_info
        ;;
      2)
        update_system
        ;;
      # ... çœç•¥éƒ¨åˆ† case ...
      99) 
        local auto_install="false" # ä»èœå•é€‰æ‹©ï¼Œä¸æ˜¯è‡ªåŠ¨å®‰è£…
        install_shortcut
        ;;
      00)
        update_script
        ;;
      0)
        echo -e "${C_GREEN}æ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼${C_RESET}"
        exit 0
        ;;
      *)
        echo -e "${C_RED}æ— æ•ˆçš„è¾“å…¥ï¼Œè¯·è¾“å…¥èœå•ä¸­å­˜åœ¨çš„æ•°å­—é€‰é¡¹ï¼${C_RESET}"
        press_any_key_to_continue
        ;;
      esac
    done
}


# ===================================================================================
# --- è„šæœ¬ä¸»å…¥å£é€»è¾‘ --- # <--- è¿™æ˜¯æ–°å¢çš„æ ¸å¿ƒåˆ¤æ–­é€»è¾‘
# ===================================================================================

readonly INSTALL_PATH="/usr/local/bin/tools"

# åˆ¤æ–­è„šæœ¬æ˜¯å¦å·²å®‰è£…
if [ ! -f "${INSTALL_PATH}" ]; then
  # å¦‚æœ /usr/local/bin/tools æ–‡ä»¶ä¸å­˜åœ¨, åˆ™æ‰§è¡Œé¦–æ¬¡è¿è¡Œçš„è‡ªåŠ¨å®‰è£…é€»è¾‘
  clear
  echo -e "${C_CYAN}æ¬¢è¿ä½¿ç”¨å·¥å…·ç®±, æ£€æµ‹åˆ°æ˜¯é¦–æ¬¡è¿è¡Œã€‚${C_RESET}"
  echo -e "${C_YELLOW}ä¸ºäº†æ–¹ä¾¿æ‚¨æœªæ¥ä½¿ç”¨, è„šæœ¬å°†è‡ªåŠ¨ä¸ºæ‚¨å®‰è£… 'y' å¿«æ·æŒ‡ä»¤ã€‚${C_RESET}"
  echo -e "å®‰è£…è¿‡ç¨‹éœ€è¦ sudo æƒé™, å¦‚æœå½“å‰ä¸æ˜¯rootç”¨æˆ·, å¯èƒ½ä¼šæç¤ºæ‚¨è¾“å…¥å¯†ç ã€‚"
  echo -e "---------------------------------------------------------------------"
  
  # è®¾ç½®ä¸€ä¸ªæ ‡è®°ï¼Œè®©å®‰è£…å‡½æ•°çŸ¥é“è¿™æ˜¯è‡ªåŠ¨å®‰è£…
  local auto_install="true"
  
  # ç›´æ¥è°ƒç”¨å®‰è£…å‡½æ•°, å¹¶æ£€æŸ¥å…¶æ˜¯å¦æˆåŠŸ
  if install_shortcut; then
    # å¦‚æœå®‰è£…æˆåŠŸ
    echo -e "\n${C_GREEN}å®‰è£…æµç¨‹æ‰§è¡Œå®Œæ¯•, è¯·æŒ‰æŒ‡ç¤ºæ“ä½œä»¥ä½¿ç”¨å¿«æ·æŒ‡ä»¤ã€‚${C_RESET}"
  else
    # å¦‚æœå®‰è£…å¤±è´¥ (ä¾‹å¦‚, ç”¨æˆ·æ²¡æœ‰sudoæƒé™)
    echo -e "\n${C_RED}å®‰è£…å¤±è´¥, è„šæœ¬å°†è¿›å…¥ä¸´æ—¶ä¼šè¯æ¨¡å¼ã€‚${C_RESET}"
    echo -e "${C_YELLOW}æ‚¨å¯ä»¥ç»§ç»­åœ¨æœ¬æ¬¡ä¼šè¯ä¸­ä½¿ç”¨èœå•, ä½†å¿«æ·æŒ‡ä»¤ 'y' å°†ä¸å¯ç”¨ã€‚${C_RESET}"
    press_any_key_to_continue
    main_loop # å®‰è£…å¤±è´¥åˆ™ç›´æ¥è¿›å…¥èœå•
  fi
  
  # è‡ªåŠ¨å®‰è£…æˆåŠŸåï¼Œè„šæœ¬é€€å‡ºï¼Œæç¤ºç”¨æˆ·ä½¿ç”¨æ–°å‘½ä»¤
  exit 0

else
  # å¦‚æœ /usr/local/bin/tools æ–‡ä»¶å·²å­˜åœ¨, åˆ™ç›´æ¥è¿›å…¥ä¸»èœå•å¾ªç¯
  main_loop
fi
