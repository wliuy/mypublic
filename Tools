#!/usr/bin/env bash

#
# AYANG's Toolbox v3.0 (åŠŸèƒ½å‡çº§ & æ™ºèƒ½å®‰è£…)
#

# --- é¢œè‰²å®šä¹‰ (æºäº kejilion.sh) ---
gl_hui='\e[37m'
gl_hong='\033[31m'
gl_lv='\033[32m'
gl_huang='\033[33m'
gl_lan='\033[34m'
gl_bai='\033[0m'
gl_zi='\033[35m'
gl_kjlan='\033[96m'


# --- è¾…åŠ©å‡½æ•° (æºäº kejilion.sh) ---

# æ“ä½œå®Œæˆåçš„æš‚åœæç¤º
function press_any_key_to_continue() {
	  echo -e "\n${gl_huang}æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•...${gl_bai}"
	  read -n 1 -s -r -p ""
}

# é€šç”¨å®‰è£…å‡½æ•° (æºäº kejilion.sh)
install() {
	if [ $# -eq 0 ]; then
		echo "æœªæä¾›è½¯ä»¶åŒ…å‚æ•°!"
		return 1
	fi

	for package in "$@"; do
		if ! command -v "$package" &>/dev/null; then
			echo -e "${gl_huang}æ­£åœ¨å®‰è£… $package...${gl_bai}"
			if command -v dnf &>/dev/null; then
				dnf install -y "$package"
			elif command -v yum &>/dev/null; then
				yum install -y "$package"
			elif command -v apt &>/dev/null; then
				apt update -y
				apt install -y "$package"
			elif command -v apk &>/dev/null; then
				apk add "$package"
			elif command -v pacman &>/dev/null; then
				pacman -S --noconfirm "$package"
			else
				echo "æœªçŸ¥çš„åŒ…ç®¡ç†å™¨!"
				return 1
			fi
		fi
	done
}

# --- åŠŸèƒ½å‡½æ•°å®šä¹‰ ---

# 1. ç³»ç»Ÿä¿¡æ¯æŸ¥è¯¢ (ä»£ç æºäº kejilion.sh çš„ linux_ps å‡½æ•°)
function system_info() {
	clear
	ipv4_address=$(curl -s https://ipinfo.io/ip)
	ipv6_address=$(curl -s --max-time 1 https://v6.ipinfo.io/ip)
	local cpu_info=$(lscpu | awk -F': +' '/Model name:/ {print $2; exit}')
	local cpu_usage_percent=$(awk '{u=$2+$4; t=$2+$4+$5; if (NR==1){u1=u; t1=t;} else printf "%.0f\n", (($2+$4-u1) * 100 / (t-t1))}' <(grep 'cpu ' /proc/stat) <(sleep 1; grep 'cpu ' /proc/stat))
	local cpu_cores=$(nproc)
	local mem_info=$(free -b | awk 'NR==2{printf "%.2f/%.2fG (%.2f%%)", $3/1024/1024/1024, $2/1024/1024/1024, $3*100/$2}')
	local disk_info=$(df -h | awk '$NF=="/"{printf "%s/%s (%s)", $3, $2, $5}')
	local country=$(curl -s ipinfo.io/country)
	local city=$(curl -s ipinfo.io/city)
	local isp_info=$(curl -s ipinfo.io/org)
	local load=$(uptime | awk '{print $(NF-2), $(NF-1), $NF}')
	local cpu_arch=$(uname -m)
	local hostname=$(uname -n)
	local kernel_version=$(uname -r)
	local os_info=$(grep PRETTY_NAME /etc/os-release | cut -d '=' -f2 | tr -d '"')
	local runtime=$(cat /proc/uptime | awk -F. '{run_days=int($1 / 86400);run_hours=int(($1 % 86400) / 3600);run_minutes=int(($1 % 3600) / 60); if (run_days > 0) printf("%då¤© ", run_days); if (run_hours > 0) printf("%dæ—¶ ", run_hours); printf("%dåˆ†\n", run_minutes)}')

	echo ""
	echo -e "ç³»ç»Ÿä¿¡æ¯æŸ¥è¯¢"
	echo -e "${gl_kjlan}-------------"
	echo -e "${gl_kjlan}ä¸»æœºå:       ${gl_bai}$hostname"
	echo -e "${gl_kjlan}ç³»ç»Ÿç‰ˆæœ¬:     ${gl_bai}$os_info"
	echo -e "${gl_kjlan}Linuxç‰ˆæœ¬:    ${gl_bai}$kernel_version"
	echo -e "${gl_kjlan}-------------"
	echo -e "${gl_kjlan}CPUæ¶æ„:      ${gl_bai}$cpu_arch"
	echo -e "${gl_kjlan}CPUå‹å·:      ${gl_bai}$cpu_info"
	echo -e "${gl_kjlan}CPUæ ¸å¿ƒæ•°:    ${gl_bai}$cpu_cores"
	echo -e "${gl_kjlan}-------------"
	echo -e "${gl_kjlan}CPUå ç”¨:      ${gl_bai}$cpu_usage_percent%"
	echo -e "${gl_kjlan}ç³»ç»Ÿè´Ÿè½½:     ${gl_bai}$load"
	echo -e "${gl_kjlan}ç‰©ç†å†…å­˜:     ${gl_bai}$mem_info"
	echo -e "${gl_kjlan}ç¡¬ç›˜å ç”¨:     ${gl_bai}$disk_info"
	echo -e "${gl_kjlan}-------------"
	if [ -n "$ipv4_address" ]; then echo -e "${gl_kjlan}IPv4åœ°å€:     ${gl_bai}$ipv4_address"; fi
	if [ -n "$ipv6_address" ]; then echo -e "${gl_kjlan}IPv6åœ°å€:     ${gl_bai}$ipv6_address"; fi
	echo -e "${gl_kjlan}è¿è¥å•†:       ${gl_bai}$isp_info"
	echo -e "${gl_kjlan}åœ°ç†ä½ç½®:     ${gl_bai}$country $city"
	echo -e "${gl_kjlan}-------------"
	echo -e "${gl_kjlan}è¿è¡Œæ—¶é•¿:     ${gl_bai}$runtime"
	echo
}

# 2. ç³»ç»Ÿæ›´æ–° (ä»£ç æºäº kejilion.sh)
function system_update() {
	echo -e "${gl_huang}æ­£åœ¨ç³»ç»Ÿæ›´æ–°...${gl_bai}"
	if command -v dnf &>/dev/null; then dnf -y update
	elif command -v yum &>/dev/null; then yum -y update
	elif command -v apt &>/dev/null; then apt update -y && apt full-upgrade -y
	elif command -v apk &>/dev/null; then apk update && apk upgrade
	elif command -v pacman &>/dev/null; then pacman -Syu --noconfirm
	else echo "æœªçŸ¥çš„åŒ…ç®¡ç†å™¨!"; return; fi
}

# 3. ç³»ç»Ÿæ¸…ç† (ä»£ç æºäº kejilion.sh)
function system_clean() {
	echo -e "${gl_huang}æ­£åœ¨ç³»ç»Ÿæ¸…ç†...${gl_bai}"
	if command -v dnf &>/dev/null; then dnf autoremove -y && dnf clean all && journalctl --rotate && journalctl --vacuum-time=1s
	elif command -v yum &>/dev/null; then yum autoremove -y && yum clean all && journalctl --rotate && journalctl --vacuum-time=1s
	elif command -v apt &>/dev/null; then apt autoremove --purge -y && apt clean -y && apt autoclean -y && journalctl --rotate && journalctl --vacuum-time=1s
	elif command -v apk &>/dev/null; then rm -rf /var/cache/apk/*
	elif command -v pacman &>/dev/null; then pacman -Rns $(pacman -Qdtq) --noconfirm && pacman -Scc --noconfirm && journalctl --rotate && journalctl --vacuum-time=1s
	else echo "æœªçŸ¥çš„åŒ…ç®¡ç†å™¨!"; return; fi
}

# 6. Dockerç®¡ç†
function docker_install_helper() {
	echo -e "${gl_huang}æ­£åœ¨å®‰è£…dockerç¯å¢ƒ...${gl_bai}"
    if ! command -v docker &>/dev/null; then curl -fsSL https://get.docker.com | sh; fi
    local country=$(curl -s ipinfo.io/country)
    if [ "$country" = "CN" ]; then
        mkdir -p /etc/docker
        cat > /etc/docker/daemon.json << EOF
{ "registry-mirrors": ["https://docker.m.daocloud.io", "https://docker.1panel.live", "https://docker.aliyuncs.com"] }
EOF
    fi
    systemctl enable docker && systemctl restart docker
    install docker-compose
    echo -e "${gl_lv}Docker ç¯å¢ƒå®‰è£…/æ›´æ–°å®Œæˆï¼${gl_bai}"
}
function docker_container_menu() {
    while true; do
        clear; echo "Dockerå®¹å™¨åˆ—è¡¨"; docker ps -a --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"; echo ""; echo "å®¹å™¨æ“ä½œ"; echo "------------------------"
        echo "1. å¯åŠ¨æŒ‡å®šå®¹å™¨             2. åœæ­¢æŒ‡å®šå®¹å™¨"; echo "3. åˆ é™¤æŒ‡å®šå®¹å™¨             4. é‡å¯æŒ‡å®šå®¹å™¨"; echo "5. æŸ¥çœ‹å®¹å™¨æ—¥å¿—             6. è¿›å…¥å®¹å™¨ç»ˆç«¯"; echo "------------------------"; echo "0. è¿”å›Dockerä¸»èœå•"; echo "------------------------"
        read -p "è¯·è¾“å…¥ä½ çš„é€‰æ‹©: " sub_choice
        case $sub_choice in
            1) read -p "è¯·è¾“å…¥è¦å¯åŠ¨çš„å®¹å™¨åæˆ–ID: " name; docker start $name ;;
            2) read -p "è¯·è¾“å…¥è¦åœæ­¢çš„å®¹å™¨åæˆ–ID: " name; docker stop $name ;;
            3) read -p "è¯·è¾“å…¥è¦åˆ é™¤çš„å®¹å™¨åæˆ–ID: " name; docker rm -f $name ;;
            4) read -p "è¯·è¾“å…¥è¦é‡å¯çš„å®¹å™¨åæˆ–ID: " name; docker restart $name ;;
            5) read -p "è¯·è¾“å…¥è¦æŸ¥çœ‹æ—¥å¿—çš„å®¹å™¨åæˆ–ID: " name; docker logs $name ;;
            6) read -p "è¯·è¾“å…¥è¦è¿›å…¥çš„å®¹å™¨åæˆ–ID: " name; docker exec -it $name /bin/sh ;;
            0) break ;;
            *) echo "æ— æ•ˆè¾“å…¥" ;;
        esac
        echo -e "\næ“ä½œå®Œæˆï¼ŒæŒ‰ä»»æ„é”®ç»§ç»­..."; read -n 1 -s -r
    done
}
function docker_image_menu() {
    while true; do
        clear; echo "Dockeré•œåƒåˆ—è¡¨"; docker image ls; echo ""; echo "é•œåƒæ“ä½œ"; echo "------------------------"
        echo "1. æ‹‰å–æŒ‡å®šé•œåƒ             2. åˆ é™¤æŒ‡å®šé•œåƒ"; echo "3. æ¸…ç†æ— ç”¨é•œåƒ"; echo "------------------------"; echo "0. è¿”å›Dockerä¸»èœå•"; echo "------------------------"
        read -p "è¯·è¾“å…¥ä½ çš„é€‰æ‹©: " sub_choice
        case $sub_choice in
            1) read -p "è¯·è¾“å…¥è¦æ‹‰å–çš„é•œåƒå (ä¾‹å¦‚: ubuntu:latest): " name; docker pull $name ;;
            2) read -p "è¯·è¾“å…¥è¦åˆ é™¤çš„é•œåƒåæˆ–ID: " name; docker rmi -f $name ;;
            3) docker image prune -af ;;
            0) break ;;
            *) echo "æ— æ•ˆè¾“å…¥" ;;
        esac
        echo -e "\næ“ä½œå®Œæˆï¼ŒæŒ‰ä»»æ„é”®ç»§ç»­..."; read -n 1 -s -r
    done
}
function docker_management() {
    while true; do
        clear; echo "Docker ç®¡ç†"; if command -v docker &> /dev/null; then docker -v; docker compose version; else echo -e "${gl_hui}Docker æœªå®‰è£…${gl_bai}"; fi
        echo -e "${gl_kjlan}------------------------"; echo "1. å®‰è£…/æ›´æ–° Docker ç¯å¢ƒ"; echo "2. ç®¡ç† Docker å®¹å™¨"; echo "3. ç®¡ç† Docker é•œåƒ"; echo "4. æŸ¥çœ‹ Docker å…¨å±€çŠ¶æ€"; echo "5. æ¸…ç†æ— ç”¨çš„Dockeræ•°æ®"; echo -e "${gl_kjlan}------------------------"; echo "0. è¿”å›ä¸»èœå•"; echo -e "${gl_kjlan}------------------------${gl_bai}"
        read -p "è¯·è¾“å…¥ä½ çš„é€‰æ‹©: " choice
        case $choice in
            1) clear; docker_install_helper; break_end ;;
            2) docker_container_menu ;;
            3) docker_image_menu ;;
            4) clear; docker system df; press_any_key_to_continue ;;
            5) clear; docker system prune -af --volumes; press_any_key_to_continue ;;
            0) break ;;
            *) echo "æ— æ•ˆè¾“å…¥" ;;
        esac
    done
}

# (æ ¸å¿ƒåŠŸèƒ½) å®‰è£…å¿«æ·æŒ‡ä»¤
function install_shortcut() {
  local script_url="https://raw.githubusercontent.com/wliuy/mypublic/refs/heads/main/Tools"
  local install_name="tools"
  local shortcut_name="y"
  local install_path="/usr/local/bin/${install_name}"
  local shortcut_path="/usr/local/bin/${shortcut_name}"

  echo -e "${gl_kjlan}å¼€å§‹å®‰è£…å¿«æ·æ–¹å¼ '${shortcut_name}'...${gl_bai}"

  if [[ "$(id -u)" -ne 0 ]]; then
    echo -e "${gl_hong}é”™è¯¯ï¼šå®‰è£…è¿‡ç¨‹éœ€è¦ root æƒé™ã€‚${gl_bai}";
    echo -e "${gl_huang}è¯·å°è¯•ä½¿ç”¨ 'sudo bash <(curl...)' æ¥è¿è¡Œæ­¤è„šæœ¬ã€‚${gl_bai}"
    return 1
  fi

  echo -e "${gl_lan}æ­£åœ¨ä» GitHub ä¸‹è½½æœ€æ–°ç‰ˆè„šæœ¬åˆ° ${install_path}...${gl_bai}"
  if curl -L "${script_url}" -o "${install_path}"; then
    echo -e "${gl_lv}ä¸‹è½½æˆåŠŸï¼${gl_bai}"
  else
    echo -e "${gl_hong}é”™è¯¯ï¼šä¸‹è½½è„šæœ¬å¤±è´¥ã€‚${gl_bai}"; return 1;
  fi

  echo -e "${gl_lan}æ­£åœ¨è®¾ç½®æ‰§è¡Œæƒé™...${gl_bai}"; chmod +x "${install_path}"
  echo -e "${gl_lan}æ­£åœ¨åˆ›å»ºå¿«æ·å‘½ä»¤ '${shortcut_name}'...${gl_bai}"; ln -sf "${install_path}" "${shortcut_path}"
  
  echo -e "\n${gl_lv}ğŸ‰ æ­å–œï¼å¿«æ·æ–¹å¼å®‰è£…æˆåŠŸï¼${gl_bai}"
  echo -e "ä¸‹æ¬¡ç™»å½•å, ä½ å°±å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ç›´æ¥è¾“å…¥ '${gl_huang}${shortcut_name}${gl_bai}' æ¥è¿è¡Œæ­¤å·¥å…·ç®±äº†ã€‚"
  return 0
}


# --- ä¸»èœå•æ˜¾ç¤º ---
function main_menu() {
  clear
  echo -e "${gl_kjlan}"
  echo -e "    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—"
  echo -e "   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•"
  echo -e "   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—"
  echo -e "   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘"
  echo -e "   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•"
  echo -e "   â•šâ•â•  â•šâ•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â•"
  echo -e "${gl_bai}"
  echo -e "${gl_lan}               AYANG's Toolbox v1.0.3               ${gl_bai}"
  echo -e "${gl_kjlan}----------------------------------------------------${gl_bai}"
  echo -e "${gl_kjlan}1.  ${gl_bai}ç³»ç»Ÿä¿¡æ¯æŸ¥è¯¢"
  echo -e "${gl_kjlan}2.  ${gl_bai}ç³»ç»Ÿæ›´æ–°"
  echo -e "${gl_kjlan}3.  ${gl_bai}ç³»ç»Ÿæ¸…ç†"
  echo -e "${gl_kjlan}6.  ${gl_bai}Dockerç®¡ç†"
  echo -e "${gl_kjlan}----------------------------------------------------${gl_bai}"
  echo -e "${gl_kjlan}0.  ${gl_bai}é€€å‡ºè„šæœ¬"
  echo -e "${gl_kjlan}----------------------------------------------------${gl_bai}"
  read -p "è¯·è¾“å…¥ä½ çš„é€‰æ‹©: " choice
}

# --- ä¸»å¾ªç¯ ---
function main_loop() {
    while true; do
      main_menu
      case $choice in
        1) system_info; press_any_key_to_continue ;;
        2) clear; system_update; press_any_key_to_continue ;;
        3) clear; system_clean; press_any_key_to_continue ;;
        6) docker_management ;;
        0) clear; exit ;;
        *) echo -e "${gl_hong}æ— æ•ˆçš„è¾“å…¥!${gl_bai}"; sleep 1 ;;
      esac
    done
}


# ===================================================================================
# --- è„šæœ¬ä¸»å…¥å£é€»è¾‘ (v1.0 æ ¸å¿ƒåŠŸèƒ½å›å½’) ---
# ===================================================================================

readonly INSTALL_PATH="/usr/local/bin/tools"

# åˆ¤æ–­è„šæœ¬æ˜¯å¦å·²å®‰è£…
if [ ! -f "${INSTALL_PATH}" ]; then
  # é¦–æ¬¡è¿è¡Œï¼Œæ‰§è¡Œè‡ªåŠ¨å®‰è£…
  clear
  echo -e "${gl_kjlan}æ¬¢è¿ä½¿ç”¨ AYANG's Toolbox, æ£€æµ‹åˆ°æ˜¯é¦–æ¬¡è¿è¡Œã€‚${gl_bai}"
  echo -e "${gl_huang}ä¸ºäº†æ–¹ä¾¿æ‚¨æœªæ¥ä½¿ç”¨, è„šæœ¬å°†è‡ªåŠ¨ä¸ºæ‚¨å®‰è£… 'y' å¿«æ·æŒ‡ä»¤ã€‚${gl_bai}"
  echo -e "---------------------------------------------------------------------"
  
  install_shortcut
  
  echo -e "\n${gl_lv}å®‰è£…æµç¨‹æ‰§è¡Œå®Œæ¯•ï¼${gl_bai}"
  echo -e "${gl_huang}æ­£åœ¨ç»§ç»­è¿›å…¥ä¸»èœå•...${gl_bai}"
  sleep 3
fi

# æ— è®ºæ˜¯é¦–æ¬¡è¿è¡Œå®‰è£…å, è¿˜æ˜¯ä¹‹åç›´æ¥è¿è¡Œ, æœ€ç»ˆéƒ½ä¼šæ‰§è¡Œä¸»å¾ªç¯
main_loop
